# SubPub gRPC Сервис
## Возможности

*   **Subscribe:** Клиенты могут подписываться на события по строковому ключу. Они получают поток событий, опубликованных по этому ключу.

*   **Publish:** Клиенты могут публиковать строковые данные, ассоциированные с ключом. Все активные подписчики на этот ключ получат данные.

*   **Config:** Порт сервиса и другие параметры настраиваются через `config.yaml` или переменные окружения. 

*   **Логирование:** JSON-логирование с использованием `slog`. Уровень логирования настраиваемый (debug, info, warn, error), поставил debug, чтоб было более наглядно. 

*   **Graceful Shutdown:** Сервис обрабатывает сигналы `SIGINT` и `SIGTERM` для корректного завершения работы: завершает текущие запросы и очищает ресурсы.

*   **Keepalive:** Настройки gRPC keepalive используются для управления неактивными соединениями.

## Немного про паттерны

* Как и предложено в задании, сделал graceful shutdown и DI.
* Также есть фабрика для создания сервиса `SubPub`, фактически это и позволяет добиться DI (более высокий gRPC сервер зависит от логгера и сервиса, при этом не создает их внутри).
* Сам пакет реализует паттерн наблюдатель и команда (но это заложено в самой логике, поэтому это не так важно)
Из более глобальных паттернов это всё, хотя можно было добавить например билдер, например для сервера, но мне кажется это лишним в проекте.

## Логика программы

1.  **Основная логика (`internal/subpub`):** Пакет `subpub` управляет топиками (ключами) и списками подписчиков в памяти. Использует каналы и горутиныы для доставки сообщений.

2.  **gRPC Сервер (`internal/server`):**

    *   Реализует сервис `PubSub`, определённый в `api/proto/subpub.proto`.
    
    *   Зависит от экземпляра интерфейса `subpub.SubPub` и `slog.Logger`.

    *   Метод `Publish` валидирует запрос и вызывает метод `subpub.Publish`.

    *   Метод `Subscribe` валидирует запрос, вызывает `subpub.Subscribe` с обработчиком, а затем запускает цикл:

        *   Слушает сообщения, отправленные обработчиком `subpub` в канал.

        *   Следит за отключением клиента через контекст потока (`stream.Context().Done()`).

        *   При получении сообщения отправляет его клиенту через поток.

        *   При отключении клиента или ошибке потока, цикл завершает работу, а `defer sub.Unsubscribe()` очищает подписку.

3.  **Точка входа приложения (`cmd/server/main.go`):**

    *   Загружает конфигурацию с помощью `cleanenv`.

    *   Настраивает логгер `slog`.

    *   Создаёт экземпляр `subpub`.

    *   Создаёт gRPC-сервер, внедряя в него `subpub` и логгер.

    *   Запускает gRPC-listener и сервер в отдельной горутине.

    *   Слушает сигналы завершения (`SIGINT`, `SIGTERM`).

    *   При получении сигнала инициирует `grpcServer.GracefulStop()` для завершения соединений, затем вызывает `subpub.Close()` для очистки внутреннего состояния.

## Сборка и запуск

### Зависимости

*   Go (версия 1.21 или выше, возможно ниже, но не пробовал, для `slog` требуется 1.21)

    ```bash
    go mod tidy
    ```
    *Если нужно перегенерировать proto файлы, то нужны еще protoc-gen-go и protoc-gen-go-grpc*

### Шаги

1.  **Склонируйте репозиторий:**

    ```bash
    git clone https://github.com/ProgrammerPeasant/subpub.git
    ```
    Передите в корент проекта:

    ```bash
    cd subpub
    ```

3.  **Загрузите зависимости:**

    ```bash
    go mod tidy
    ```

4.  **Настройте:**

    *   Редактируйте `config.yaml`, если нужно или создайте в том же каталоге, где находится бинарный файл.

    *   Можнно переопределить настройки с помощью переменных окружения.

5.  **Запустите сервис:**
    
    Из корневой директории проекта выполните:
    ```bash
    go run ./cmd/main.go
    ```
    Сервер начнёт прослушивание на настроенном gRPC-порту (по умолчанию `:50051`).

    Опционально можете собрать бинарный файл:

    ```bash
    go build -o pubsub_server ./cmd/server/main.go
    ```

## Тестирование

1.  **Тесты пакета subpub:** 88% покрытия

    Как и указано в задании, есть отдельные тесты (юнит-тесты) для пакета `subpub`. Они находятся в `internal/subpub/subpub_test.go`.
    ```bash
    go test .\internal\service\subpub
    ```

   2.  **Тестирование gRPC сервиса:**

    Я тестировал через gRPC Web UI (grpcui), но можно и через `grpcurl` (или любой другой gRPC клиент), хотя с винды это просто адски неудобно.
    Также можно указывать таймауты для запросов.

    Вот примеры запросов (на дебаг режиме видно сообщения, полученные разными подписчиками и т. д.):

       ```bash
       grpcurl -plaintext -d '{
          "key": "123",
          "data": "123"
       }' localhost:50051 pubsub.v1.PubSub.Publish
       ```
       
       ```bash
       grpcurl -plaintext -d '{
        "key": "123"
       }' localhost:50051 pubsub.v1.PubSub.Subscribe
       ```
